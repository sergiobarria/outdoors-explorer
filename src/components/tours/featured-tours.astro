---
import { eq } from 'drizzle-orm';

import { db } from '@/db';
import { getImageUrl } from '@/lib/s3';
import TourCard from '@/components/tours/tour-card.astro';

async function getFeaturedTours() {
	const tours = await db.query.toursTable.findMany({
		where: (records) => eq(records.isFeatured, true),
		columns: { created: false, modified: false, description: false },
		with: {
			images: {
				columns: { imageKey: true },
				limit: 1
			},
			startDates: {
				columns: { date: true }
			}
		},
		limit: 3
	});

	return tours.map((tour) => ({
		...tour,
		images: tour.images.map((image) => getImageUrl(image.imageKey)),
		startDates: tour.startDates.map((date) => date.date)
	}));
}

const featuredTours = await getFeaturedTours();
---

{featuredTours.map((tour) => <TourCard tour={tour} />)}
